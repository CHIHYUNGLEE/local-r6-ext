function OpnViewer(parent,style){this.style=style||{};this.parent=parent;this.className=this.style.className||"OpnViewer";this.isCenter=this.style.isCenter?eval(this.style.isCenter):false;this.isHideBorder=this.style.isHideBorder?eval(this.style.isHideBorder):false;this.isFold=(this.style.isFold&&this.style.isFold=="true")?true:false;this.maxLength=this.style.maxLength?parseInt(this.style.maxLength):600;this.reloadUrl=this.style.reloadUrl;this.useEditable=this.style.useEditable?eval(this.style.useEditable):false;this.vrtl=this.style.vrtl||null;this.countPerOne=this.style.countPerOne||30;this.layerMode=this.style.layerMode?eval(this.style.layerMode):false;this.printMode=this.style.printMode?eval(this.style.printMode):false;this.mentionUse=OpnWriter.mentionUseGlobal&&(this.style.mentionUse==null?true:eval(this.style.mentionUse));if(this.layerMode){this.printMode=true}this.opnList={};this.seq=JSV.SEQUENCE++;this.appendRight=$(this.parent).hasClass("TemplateLayoutContent");var moreCnt=JSV.loadJSON("/jsl/ConfigAction.Value.json","key=com.kcube.doc.opn.OpinionConfig.more");this.moreCnt=moreCnt&&moreCnt.value&&moreCnt.value>0?moreCnt.value:50;this.desc=this.style.desc||true;this.lastId=0;this.gs=JSV.getParameter(this.style.gs)||JSV.getParameter("gs")||"";this.dataName=this.style.dataName||"opinions";this.itemIdName=this.style.itemIdName?this.style.itemIdName:"id";this.itemId=this.style.itemId?this.style.itemId:"id";this.itemIdVal=this.style.itemIdVal;this.hashOpnId=JSV.getParameter("hashOpnId");this.isFix=(null!=this.style.isFix)?eval(this.style.isFix):false;this.closestSlt=this.style.closestSlt||null;this.moreBtnEvent=true;var self=this;var headerName=this.style.headerName||JSV.getLang("OpnViewer","opn");if(this.appendRight&&!this.desc){OpnViewer.RIGHTFRAME=$(this.parent).parent().get(0)}var opnCnt=this.appendRight?'<div class="opnVwCntDiv" id="opnVwCntMain'+this.seq+'">										<ul class="tab"><li class="tabItem selected" id="opnVwCntMainLi'+this.seq+'">										<a id="opnVwCntA'+this.seq+'" hidefocus="true" class="opnCntA">										<span class="text selectedTab">'+JSV.getLang("OpnViewer","opn")+'</span><span class="number selectedNumberTab" id="opnVwCnt'+this.seq+'"></span>										</a></li></ul>									</div>':'<div id="opnVwCntMain'+this.seq+'" class="opnVwCntBDiv">											<ul class="tab"><li class="tabItem selected" id="opnVwCntArrow'+this.seq+'">												<a id="opnVwCntA'+this.seq+'" hidefocus="true" class="opnCntA">												<span class="text selectedTab">'+JSV.getLang("OpnViewer","opn")+'</span><span class="number selectedNumberTab" id="opnVwCnt'+this.seq+'"></span>'+(this.style.sympathy?'<span class="bar">/</span>															  <span class="text selectedTab">'+JSV.getLang("SympathyViewer","symp")+'</span><span class="number selectedNumberTab" id="sympVwCnt'+this.seq+'"></span>':"")+'</a></li><li class="refresh"><img id="refreshBtn'+this.seq+'" src="../../img/personal_btn_refresh.png"/></li></ul></div>';this.widget=$("<div>"+opnCnt+'<div class="opnVwContent" id="opnVwContent'+this.seq+'">							<div id="opnVwHeadDiv'+this.seq+'"></div>							<ul class="opnVwVsbUl" id="opnVwVsbUl'+this.seq+'">								<li class="opnVwWrtRpy" id="opnVwWrtRpy'+this.seq+'">									 <i class="i_cmt_reply"></i>								</li>							</ul>							<div id="opnVwTailDiv'+this.seq+'"></div>							<div id="opnVwMoreBar'+this.seq+'" class="opnVwMoreBar"></div>						</div>					</div>').attr("seq",this.seq).addClass(this.className).appendTo(parent);if(this.style.opnView){this.widget.find("#opnVwHeadDiv"+this.seq).after('<div class="opnVwFilter" id="opnVwFilter'+this.seq+'">						<a href="javascript:void(0);" class="select_filter" id="desc">'+JSV.getLang("OpnViewer","desc")+'</a>						<a href="javascript:void(0);" class="select_filter" id="asc">'+JSV.getLang("OpnViewer","asc")+"</a>					</div>");if(this.desc){this.widget.find("#opnVwFilter"+this.seq).children("#desc").addClass("selected")}else{this.widget.find("#opnVwFilter"+this.seq).children("#asc").addClass("selected")}}if(this.appendRight){if(this.style.rightColor){$(this.parent).parent().css("background-color",this.style.rightColor)}this.widget.addClass("right");if(this.style.sympathy){this.widget.addClass("sympathy")}}this.writerArea=$("#opnVwHeadDiv"+this.seq).addClass("writerArea").get(0);if(this.layerMode){this.widget.addClass("OpnViewerLayer")}if(this.printMode){$("#opnVwWrtRpy"+this.seq).remove()}else{this.hiddenLi=$("#opnVwWrtRpy"+this.seq);this.writer=new OpnWriter(this.hiddenLi.get(0),{resetScroll:false,maxLength:this.maxLength,className:"OpnEditor",mentionUse:this.mentionUse})}var param=[];var dataList;var opnDataList;if(this.style.opnView){this.opinionUrl=JSV.getModuleUrl("/jsl/"+this.style.opnView+".json");var selectFilter=$("#opnVwFilter"+this.seq).children(".select_filter");selectFilter.click(function(){selectFilter.removeClass("selected");$(this).toggleClass("selected");OpnViewer.cancel();self.widget.find("#opnVwVsbUl"+self.seq).find("li").not("#opnVwWrtRpy"+self.seq).remove();if(self.more){self.widget.find("#moreText"+self.seq).show();self.widget.find("#moreBar"+self.seq).show();self.widget.find("#moreBtn"+self.seq).css("cursor","pointer");self.moreBtnEvent=true}if($(this).is("#desc")){self.desc=true}else{self.desc=false}param.push(self.itemIdName+"="+self.itemIdVal);param.push("desc="+self.desc);if(self.gs){param.push("gs="+self.gs)}dataList=JSV.loadJSON(self.opinionUrl,param.join("&"));opnDataList=dataList[self.dataName];self.array=opnDataList.array;self.length=self.array.length;self.total=opnDataList.total;self.reloadCount();self.createOpinionCall(self.array);if(self.style.opnView&&!self.more&&self.total>self.length){self.more=true;self.createAreaMore()}param=[]})}var refreshBtn=$("#refreshBtn"+this.seq);var reloadUrl=this.reloadUrl;refreshBtn.click(function(){JSV.doGET(reloadUrl)})}OpnViewer.prototype.isEditable=function(b){var a=b.user.id?b.user.id:b.user.userId?b.user.userId:null;return(this.style.userId&&this.style.userId==a)||b.currentOwner};OpnViewer.prototype.isDeletable=function(b){var a=b.user.id?b.user.id:b.user.userId?b.user.userId:null;return(this.style.userId&&this.style.userId==a)||this.isCenter||b.currentOwner};OpnViewer.prototype.getValue=function(){return this.opnList};OpnViewer.prototype.setValue=function(elements,comp){this.component=comp;if(!this.itemIdVal){if(comp){this.itemIdVal=comp.getProperty(this.itemId)}if(!this.itemIdVal){this.itemIdVal=JSV.getParameter(this.itemId)}}if(elements){this.opnList=elements}if(comp&&comp.layout.form){var layout=comp.layout.form}if(this.useEditable&&elements[1]&&(typeof(eval(elements[1]))=="boolean")){this.writer.setEditable(eval(elements[1]));elements=elements[0]}this.total=elements.total||elements.totalRows||0;if(this.total==0){$("#opnVwFilter"+this.seq).hide()}if(this.style.noTitle){$("#opnVwCntMain"+this.seq).hide()}else{if(!this.appendRight){var fold=!this.isFold;$("#opnVwCntA"+this.seq).on("click",this,function(e){if(fold){$("#opnVwContent"+e.data.seq).slideUp("fast");if(layout){$(layout).find("table.opnWrtTable").slideUp("fast")}$("#opnVwCntArrow"+e.data.seq).removeClass("selected");fold=false}else{$("#opnVwContent"+e.data.seq).slideDown("fast");if(layout){$(layout).find("table.opnWrtTable").slideDown("fast")}$("#opnVwCntArrow"+e.data.seq).addClass("selected");fold=true}});if(!fold){$("#opnVwContent"+this.seq).hide();if(layout){$(layout).find("table.opnWrtTable").hide()}$("#opnVwCntArrow"+this.seq).removeClass("selected")}}$("#opnVwCnt"+this.seq).text(this.total)}this.more=((elements.rest||!isNaN(elements.rest))&&elements.rest>0)?true:false;if(this.more){if(this.style.opnView){this.createAreaMore()}}if(this.style.sympathy){this.style.sympathy.style.seq=this.seq;this.style.sympathy.style.appendRight=this.appendRight;var symComp=this.createArea($("#opnVwContent"+this.seq).get(0),this.style.sympathy);JSV.register(symComp,this,"updateSympathyCount")}this.array=elements.array;this.length=elements.array.length;this.createOpinionCall(this.array);if(OpnViewer.RIGHTFRAME){setTimeout(function(){OpnViewer.resetScroll()},500)}};OpnViewer.prototype.createArea=function(parent,obj){var clazz=eval(obj.component);var style=obj.style;var value=this.component.getProperty(obj.reference);var _clazz=new clazz(parent,style);_clazz.setValue(value,this.component);return _clazz};OpnViewer.prototype.createAreaMore=function(){$('<div class="moreVw" id="moreBtn'+this.seq+'">			<a class="btnMoreOp" id="moreText'+this.seq+'"><span>'+JSV.getLang("OpnViewer","seeMore")+'</span></a>			<span class="bar" id="moreBar'+this.seq+'"></span>			<a href="#opnVwHeadDiv'+this.seq+'" class="pageUp btnGoTopOp"><span>'+JSV.getLang("OpnViewer","topMove")+"</span></a>		</div>").appendTo(this.widget.find("#opnVwMoreBar"+this.seq).show());var a=this.widget.find("#moreBtn"+this.seq);a.find(".pageUp").on("click",this,function(b){b.stopPropagation()});a.on("click",this,function(d){if(d.data.moreBtnEvent){var f=[];f.push(d.data.itemIdName+"="+d.data.itemIdVal);f.push("desc="+d.data.desc);f.push("opnLastId="+d.data.lastId);if(d.data.gs){f.push("gs="+d.data.gs)}var c=JSV.loadJSON(d.data.opinionUrl,f.join("&"));var b=c[d.data.dataName];d.data.array=b.array;d.data.length=d.data.array.length;d.data.total=b.total;d.data.reloadCount();d.data.createOpinionCall(d.data.array);if(d.data.moreCnt>d.data.length){$(this).find("#moreText"+d.data.seq).hide();$(this).find("#moreBar"+d.data.seq).hide();a.css("cursor","default");d.data.moreBtnEvent=false}}})};OpnViewer.prototype.createOpinionCall=function(d){var b=this;var c=0;(function a(){for(var e=0;b.length&&e<b.countPerOne;e++){b.createOpinion(d[c++]).appendTo("#opnVwVsbUl"+b.seq);b.resetUnderLine();if(c>=b.length){break}}if(c<b.length){setTimeout(a,0)}else{if(b.hashOpnId){setTimeout(function(){if(document.getElementById(b.hashOpnId)){if(b.isFix){var k=undefined;var g=$("#"+b.hashOpnId).prev();if(g.length&&g.css("display")!="none"){k=g.get(0)}else{if(document.getElementById("opnVwHeadDiv"+b.seq)){k=document.getElementById("opnVwHeadDiv"+b.seq)}}if(k!==undefined){window.scrollBy(0,k.offsetTop)}}else{var j=$("#"+b.hashOpnId);var f=j.closest(b.closestSlt||"div.TemplateLayoutRight");if(f.length){var h=j.offset().top-f.offset().top;f.scrollTop(h)}else{document.getElementById(b.hashOpnId).scrollIntoView()}}}b.hashOpnId=null},200)}}})()};OpnViewer.prototype.createOpinion=function(d){var g=(this.style.isGlobal)?this.style.isGlobal:null;var k=JSV.SEQUENCE++;var j=$('<li>		<div class="inner_wrap">			<div class="thumb" id="opnVwThumb'+k+'"></div>			<p class="cmt">				<span class="username" id="opnVwName'+k+'"></span>				<span class="opnCon" id="opnVspan'+k+'"></span>			</p>			<div class="cmt_bottom">				<div class="regtime" id="opnVwTime'+k+'"></div>				<div class="cmt_fn" id="opnVwRpCtr'+k+'"></div>			</div>		</div>	</li>').attr({id:d.id,gid:d.gid,itemId:d.itemId,seq:k}).addClass("opnVwOpn").data("component",this);this.lastId=d.id;var e=d.content;if(e.indexOf("|")>-1){var h=e.indexOf("|");var f=e.substring(0,h);if(OpnWriter.Emotions[f]){e=e.substring(h+1)}}e=OpnViewer.contentDecode(e);var a=j.find("p.cmt > span.username");if(!this.layerMode&&d.gid&&d.id!=d.gid){$("<i>").addClass("i_reply").prependTo(j.find("div.inner_wrap"));j.addClass("opnReply")}if(this.vrtl!=null&&d.user.id==this.vrtl){a.html('<span class="bold">'+d.user.name)}else{if(g!=null&&g=="true"){a.html(AnchorMbr.generateBoldAnchor(d.user.id,d.user.name))}else{a.append(AnchorEmp.generateBoldAnchor(d.user.id,d.user.name))}}$("<img>").attr("src",JSV.getContextPath("/jsl/inline/ImageAction.Download?cacheOpt=DAY&path="+d.user.id+"&type="+JSV.EMPTHUMB_TYPE)).one("error",function(){$(this).attr("src",JSV.getContextPath(EmpImageViewer.DEFAULT_IMAGE))}).appendTo(j.find("div.thumb"));var b=j.find("span.opnCon").data("opnCon",e);b.append(OpnViewer.contentToMentionHtmlNodes(e,function(l){b.data("mentionUsers",l)}));OpnViewer.setTime(j.find(".regtime"),d.rgstDate);if(!this.printMode){var c=j.find("div.cmt_bottom > div.cmt_fn");if(d.id==d.gid&&this.style.actionAddUrl){$('<a href="javascript:void(0);"></a>').addClass("fn_reply").attr("title",JSV.getLang("OpnViewer","replyIcon")).text(JSV.getLang("OpnViewer","replyIcon")).appendTo(c).click(function(l){l.stopPropagation();if(OpnViewer.isEdit){OpnViewer.save();return false}OpnViewer.isReply?OpnViewer.replySave(j):OpnViewer.reply(j)})}if(this.style.opnUpdate&&this.isEditable(d)){$('<a href="javascript:void(0);"></a>').addClass("fn_edit").attr("title",JSV.getLang("OpnViewer","editIcon")).text(JSV.getLang("OpnViewer","editIcon")).appendTo(c).click(function(l){l.stopPropagation();if(OpnViewer.isReply){OpnViewer.replySave();return false}OpnViewer.isEdit?OpnViewer.save(j):OpnViewer.edit(j)})}if(this.style.opnDelete&&this.isDeletable(d)){$('<a href="javascript:void(0);"></a>').addClass("fn_del").attr("title",JSV.getLang("OpnViewer","deleteIcon")).text(JSV.getLang("OpnViewer","deleteIcon")).appendTo(c).click(function(l){JSV.confirm(JSV.getLang("OpnViewer","deleteConfirm"),function(m){if(m){OpnViewer.del(j)}})})}if(this.hideButtons){c.hide()}}return j};OpnViewer.prototype.setButtonVisible=function(a){this.hideButtons=!a};OpnViewer.prototype.notify=function(e,f){var c=this;if(e==null){return false}else{if(this.opnList.array){this.opnList.array.push(e);if(c.desc&&f.objName=="OpnWriter"){var a=this.createOpinion(e);a.prependTo("#opnVwVsbUl"+this.seq);a.find("div.inner_wrap").hide().fadeIn(700).focus();this.updateCount(OpnViewer.ADD);this.resetUnderLine();f.widget.find("#opnWrtBtn"+f.seq).children().attr("href","#"+f.wtextarea.widget.get(0).id)}else{if(c.style.opnView&&!c.desc&&f.objName=="OpnWriter"){$("#opnVwFilter"+c.seq).find("#desc").trigger("click")}}}}if(f.objName!="OpnWriter"){var d=JSV.loadJSON("/jsl/FolderAction.NodeInfo.json?folderId="+e.id);var b=((parseInt(d.flagCode)&8)!=0);if(this.writer){this.writer.setEditable(b)}}};OpnViewer.prototype.updateSympathyCount=function(a){JSV.notify(a,this,"updateSympathyCount")};OpnViewer.prototype.updateCount=function(a){this.total=(a)?++this.total:--this.total;$("#opnVwCnt"+this.seq).text(this.total);if(this.total>0){$("#opnVwFilter"+this.seq).show()}else{$("#opnVwFilter"+this.seq).hide()}this.lastId=$("#opnVwVsbUl"+this.seq).find("li:visible :last").attr("id");JSV.notify(this.total,this,"updateCount")};OpnViewer.prototype.reloadCount=function(){$("#opnVwCnt"+this.seq).text(this.total);if(this.total>0){$("#opnVwFilter"+this.seq).show()}else{$("#opnVwFilter"+this.seq).hide()}JSV.notify(this.total,this,"updateCount")};OpnViewer.prototype.resetUnderLine=function(){$("#opnVwVsbUl"+this.seq).find("li.last-child").removeClass("last-child").end().find("li:visible :last").addClass("last-child")};OpnViewer.setTime=function(b,a){if(a){if(typeof(a)!="number"){a=parseInt(a)}b.html(DateTextWriter.text(a,JSV.getLang("DateFormat","fullType1")))}};OpnViewer.edit=function(obj){if(OpnViewer.isEdit){return}var comp=obj.data("component");var seq=obj.attr("seq");var writer=comp.writer;var wWidget=$(writer.widget);var hiddenLi=comp.hiddenLi;obj.hide();hiddenLi.addClass("edit").insertAfter(obj).show();if(JSV.browser.msie6){ItemViewer.subShow(hiddenLi)}$(document).off("click.opnView").on("click.opnView",function(event){OpnViewer.save()});hiddenLi.off("click").on("click",function(event){event.stopPropagation()});var conSpan=$("#opnVspan"+seq).get(0);var textArea=$("#opnWrtText"+writer.seq);if(writer.editable){$("#opnInpNick"+writer.seq).val($("#opnVwName"+seq).text()).prev("label").hide()}if(comp.mentionUse){textArea.mentionsInput("setValue",OpnViewer.contentEncode($(conSpan).data("opnCon")))}else{textArea.val(OpnViewer.contentEncode($(conSpan).data("opnCon")))}var replaceValue=textArea.val().replace(eval("/<br>/gi"),"\r\n");textArea.val(replaceValue).keyup().focus();OpnViewer.compareValue=writer.getValue();OpnViewer.isEdit=true;OpnViewer.editor=obj;writer.onclick=function(){OpnViewer.save(OpnViewer.editor)}};OpnViewer.save=function(e){var a=OpnViewer.editor;var b=a.attr("seq");var c=$("#opnVwName"+b).text();var d=a.data("component").writer;if(d.getValue()!=""&&OpnViewer.compareValue!=d.getValue()||(d.editable&&(TrimString($("#opnInpNick"+d.seq).val())!=TrimString(c)))){if(OpnViewer.editor!=e){JSV.confirm(JSV.getLang("OpnViewer","cancelConfirm"),function(f){if(f){if(OpnViewer.isEmpty(d.getValue())){JSV.alert(JSV.getLang("OpnViewer","isEmpty"));return false}if(d.editable&&OpnViewer.isEmpty($("#opnInpNick"+d.seq).val())){JSV.alert(JSV.getLang("OpnViewer","isNameEmpty"));return false}OpnViewer.update(OpnViewer.editor);OpnViewer.cancel(OpnViewer.editor);return false}else{OpnViewer.cancel(OpnViewer.editor);if(e!=null){OpnViewer.edit(e)}return false}})}else{if(OpnViewer.isEmpty(d.getValue())){JSV.alert(JSV.getLang("OpnViewer","isEmpty"));return false}if(d.editable&&OpnViewer.isEmpty($("#opnInpNick"+d.seq).val())){JSV.alert(JSV.getLang("OpnViewer","isNameEmpty"));return false}OpnViewer.update(OpnViewer.editor);OpnViewer.cancel(OpnViewer.editor);return false}}else{OpnViewer.cancel(OpnViewer.editor);if(e!=null&&OpnViewer.editor!=e){OpnViewer.edit(e)}}};OpnViewer.update=function(c){var d=c.data("component");var h=c.attr("seq");var b=d.writer;var f=b.getValue();var g=$("#opnVspan"+h);if(d.mentionUse){var e=g.data("mentionUsers");var j=OpnWriter.removeDuplicateMention(b.getMentionUsers());j=OpnWriter.removeDiffMention(j,e);if(j.length>0){f=f.concat(OpnWriter.mentionSeperator+JSV.toJSON(j))}}var a={content:f,id:c.attr("id")};if(b.editable){a.name=TrimString($("#opnInpNick"+b.seq).val());a.vrtl=d.vrtl}$.ajax({url:JSV.getModuleUrl(JSV.getContextPath("/jsl/"+d.style.opnUpdate+".json")),dataType:"json",type:"POST",data:a,success:function(m,k){var l=OpnViewer.contentDecode(m.content);g.html("");g.data("opnCon",l);g.append(OpnViewer.contentToMentionHtmlNodes(l,function(n){g.data("mentionUsers",n)}));if(b.editable){$("#opnVwName"+h).text(m.name)}OpnViewer.setTime($("#opnVwTime"+h),m.rgstDate);for(i=0;i<d.opnList.array.length;i++){if(d.opnList.array[i].id==c.attr("id")){d.opnList.array[i].content=m.content;d.opnList.array[i].rgstDate=m.rgstDate;break}}},error:function(k){JSV.alert(JSV.getLang("OpnViewer","updateError"))}})};OpnViewer.del=function(d){var a=d.data("component");var b=$("#opnVwVsbUl"+a.seq).find("li[gid="+d.attr("id")+"]");if(b.length>1){JSV.alert(JSV.getLang("OpnViewer","delParentError"));return false}var c=a.style.opnDelete;var e=d.attr("id");$.ajax({url:JSV.getModuleUrl(JSV.getContextPath("/jsl/"+c+".json")),dataType:"html",type:"POST",data:{id:e},success:function(g,f){if(g.indexOf("error")>-1){JSV.alert(JSV.getLang("OpnViewer","delError"));return false}a.updateCount(OpnViewer.MINUS);d.fadeOut(400);window.setTimeout(function(){JSV.finalize(d.get(0));d.remove();a.resetUnderLine()},400);for(i=0;i<a.opnList.array.length;i++){if(a.opnList.array[i].id==d.attr("id")){a.opnList.array.splice(i,1);break}}},error:function(f){JSV.alert(JSV.getLang("OpnViewer","delParentError"))}})};OpnViewer.reply=function(g){if(OpnViewer.isReply){return}var c=g.data("component");var b=g.attr("seq");var d=c.writer;var a=$(d.widget);var f=c.hiddenLi;f.removeClass("edit").insertAfter(g).show();if(JSV.browser.msie6){ItemViewer.subShow(f)}c.resetUnderLine();$(document).off("click.opnView").on("click.opnView",function(j){OpnViewer.replySave();c.resetUnderLine()});f.off("click").on("click",function(j){j.stopPropagation()});var e=$("#opnVspan"+b).get(0);var h=$("#opnWrtText"+d.seq);if(d.editable){$("#opnInpNick"+d.seq).val("").trigger("blur")}if(c.mentionUse){h.mentionsInput("setValue","")}else{h.val("")}h.keyup().focus();OpnViewer.isReply=true;OpnViewer.editor=g;d.onclick=function(){d.widget.find("#opnWrtBtn"+d.seq).children().attr("href","#"+g.get(0).id);OpnViewer.replySave(OpnViewer.editor)}};OpnViewer.replySave=function(d){var a=OpnViewer.editor;var b=a.attr("seq");var c=a.data("component").writer;if(!OpnViewer.isEmpty(c.getValue())||(c.editable&&!OpnViewer.isEmpty($("#opnInpNick"+c.seq).val()))){if(OpnViewer.editor!=d){JSV.confirm(JSV.getLang("OpnViewer","replyConfirm"),function(e){if(e){if(OpnViewer.isEmpty(c.getValue())){JSV.alert(JSV.getLang("OpnViewer","isEmpty"));return false}if(c.editable&&OpnViewer.isEmpty($("#opnInpNick"+c.seq).val())){JSV.alert(JSV.getLang("OpnViewer","isNameEmpty"));return false}OpnViewer.replyUpdate(OpnViewer.editor);OpnViewer.cancel();return false}else{OpnViewer.cancel();if(d!=null){OpnViewer.reply(d)}return false}})}else{if(OpnViewer.isEmpty(c.getValue())){JSV.alert(JSV.getLang("OpnViewer","isEmpty"));return false}if(c.editable&&OpnViewer.isEmpty($("#opnInpNick"+c.seq).val())){JSV.alert(JSV.getLang("OpnViewer","isNameEmpty"));return false}OpnViewer.replyUpdate(OpnViewer.editor);OpnViewer.cancel();return false}}else{OpnViewer.cancel();if(d!=null&&OpnViewer.editor!=d){OpnViewer.reply(d)}}};OpnViewer.replyUpdate=function(e){var g=e.data("component");var d=JSV.getModuleUrl(g.style.actionAddUrl);var f=e.attr("id");var h=e.attr("itemId");var c=g.writer;var j=c.getValue();if(g.mentionUse){var k=OpnWriter.removeDuplicateMention(c.getMentionUsers());if(k.length>0){j=j.concat(OpnWriter.mentionSeperator+JSV.toJSON(k))}}var b={gid:f,itemId:h,content:j};if(c.editable){var a=TrimString($("#opnInpNick"+c.seq).val());b.user={id:g.vrtl,name:a,displayName:a}}$.ajax({url:JSV.getContextPath(d),dataType:"json",type:"POST",data:{opn:JSV.toJSON(b),gid:f,itemid:h,content:j},success:function(o,m){var l=g.createOpinion(o);var n=$("#opnVwVsbUl"+g.seq).find("li[gid="+f+"]:last");l.insertAfter(n).find("div.inner_wrap").hide().fadeIn(400).focus();g.updateCount(OpnViewer.ADD);var p=false;for(i=0;i<g.opnList.array.length+1;i++){if(g.opnList.array[i]&&g.opnList.array[i].id==f){p=true}else{if(g.opnList.array[i]&&g.opnList.array[i].gid!=f&&p){g.opnList.array.splice(i,0,o);break}else{if(!g.opnList.array[i]&&p){g.opnList.array.push(o);break}}}}},error:function(l){JSV.alert(JSV.getLang("OpnViewer","reError"))}})};OpnViewer.cancel=function(b){if(!(OpnViewer.isEdit||OpnViewer.isReply)){return false}OpnViewer.isEdit=false;OpnViewer.isReply=false;$(document).off("click.opnView");if(b!=null){var a=b.data("component").hiddenLi;a.hide();if(JSV.browser.msie6){ItemViewer.subHide(a)}b.show();OpnViewer.compareValue=null}else{var a=OpnViewer.editor.data("component").hiddenLi;a.hide();if(JSV.browser.msie6){ItemViewer.subHide(a)}}};OpnViewer.isEmpty=function(a){return $("<span>").html(OpnViewer.contentDecode(a)).text()==""};OpnViewer.showPopup=function(c){this.style=c?c:{};var e=this.style.id;var f=this.style.gs;var g=this.style.mp;var l=this.style.inAppId;var n=this.style.isGlobal;var o=this.style.isSympathy||true;var m=this.style.isAnony||false;var k=this.style.itemId||"id";var j=this.style.catalogUrl;var d=this.style.readProperty||"opinions.read";var a=this.style.writeProperty||"opinions.write";var h=this.style.targetUrl;var p="menubar=no,toolbar=no,location=no,scrollbars=no,resizable=yes";var b="/sys/jsv/doc/OpnPopup.jsp?id="+e+"&itemIdName="+k+"&readProperty="+d+"&writeProperty="+a;b+="&catalogUrl="+j+"&opnView="+this.style.opnView;b+="&isSympathy="+o;b+="&isAnony="+m;b+="&code=100";if(f){b+="&gs="+f}if(n){b+="&isGlobal="+n}if(l){b+="&inAppId="+l}if(g){b+="&"+g}else{b=JSV.getModuleUrl(b,this.style.portletId||null,true)}if(h){b+="&targetUrl="+h}if(this.style.isGroup=="true"){OpenWindowCenter.normal(690,610,"","OpnListViewer",p);JSV.doGET(b,"OpnListViewer")}else{OpenWindowCenter.normal(690,610,JSV.getContextPath(b),"OpnListViewer",p)}return};OpnViewer.contentDecode=function(a){if(a!=null){a=a.replace(/<br>/gi,"\n").replace(/[<]/gi,"&lt;").replace(/[>]/gi,"&gt;").replace(/\n/gi,"<br>")}return a};OpnViewer.contentEncode=function(a){if(a!=null){a=a.replace(/<br>/gi,"\n").replace(/&lt;/gi,"<").replace(/&gt;/gi,">")}return a};OpnViewer.resetScroll=function(b){if(OpnViewer.RIGHTFRAME){OpnViewer.RIGHTFRAME.scrollTop=OpnViewer.RIGHTFRAME.scrollHeight}else{if(b){var e=$(window);var c=b.offset().top;var f=e.scrollTop();var a=e.height();var d=c-f;if(d+110>a){$(window).scrollTop(f+((d+110)-a))}}}};OpnViewer.contentToMentionHtmlNodes=function(g,j){var h=$("<div>");var k=/@\[([^\]]+)\]\(([^ \)]+)\)/g;var e=k.exec(g);var d=new Array();while(e){var b=g.substr(0,e.index);var f=$("<span>").addClass("mentionUser").attr("uid",e[2]).text(e[1]).get(0).outerHTML;var c=g.substr(e.index+e[0].length,g.length);g=b+f+c;var a=new Object();a.id=e[2];a.name=e[1];d.push(a);e=k.exec(g)}if(j&&$.isFunction(j)){d=OpnWriter.removeDuplicateMention(d);j(d)}h.html(g);h.find("span.mentionUser").each(function(){var m=$(this);var l=AnchorEmp.generateAnchor(m.attr("uid"),m.text());m.after(l);m.remove()});return h.get(0).childNodes};OpnViewer.isReply=false;OpnViewer.isEdit=false;OpnViewer.editor=null;OpnViewer.compareValue=null;OpnViewer.ADD=true;OpnViewer.MINUS=false;OpnViewer.RIGHTFRAME=null;(function(a){a.snowfall=function(d,f){var o={flakeCount:35,flakeColor:"#ffffff",flakeIndex:999999,minSize:1,maxSize:2,minSpeed:1,maxSpeed:5,round:false,shadow:false,collection:false,collectionHeight:40,deviceorientation:false},f=a.extend(o,f),b=function b(z,w){return Math.round(z+Math.random()*(w-z))};a(d).data("snowfall",this);function h(C,B,A,z,D){this.id=D;this.x=C;this.y=B;this.size=A;this.speed=z;this.step=0;this.stepSize=b(1,10)/100;if(f.collection){this.target=v[b(0,v.length-1)]}var w=a(document.createElement("div")).attr({"class":"snowfall-flakes",id:"flake-"+this.id}).css({width:this.size,height:this.size,background:f.flakeColor,position:"absolute",top:this.y,left:this.x,fontSize:0,zIndex:f.flakeIndex});if(a(d).get(0).tagName===a(document).get(0).tagName){a("body").append(w);d=a("body")}else{a(d).append(w)}this.element=document.getElementById("flake-"+this.id);this.update=function(){this.y+=this.speed;if(this.y>(q)-(this.size+6)){this.reset()}this.element.style.top=this.y+"px";this.element.style.left=this.x+"px";this.step+=this.stepSize;if(l===false){this.x+=Math.cos(this.step)}else{this.x+=(l+Math.cos(this.step))}if(f.collection){if(this.x>this.target.x&&this.x<this.target.width+this.target.x&&this.y>this.target.y&&this.y<this.target.height+this.target.y){var G=this.target.element.getContext("2d"),F=this.x-this.target.x,E=this.y-this.target.y,H=this.target.colData;if(H[parseInt(F)][parseInt(E+this.speed+this.size)]!==undefined||E+this.speed+this.size>this.target.height){if(E+this.speed+this.size>this.target.height){while(E+this.speed+this.size>this.target.height&&this.speed>0){this.speed*=0.5}G.fillStyle="#fff";if(H[parseInt(F)][parseInt(E+this.speed+this.size)]==undefined){H[parseInt(F)][parseInt(E+this.speed+this.size)]=1;G.fillRect(F,(E)+this.speed+this.size,this.size,this.size)}else{H[parseInt(F)][parseInt(E+this.speed)]=1;G.fillRect(F,E+this.speed,this.size,this.size)}this.reset()}else{this.speed=1;this.stepSize=0;if(parseInt(F)+1<this.target.width&&H[parseInt(F)+1][parseInt(E)+1]==undefined){this.x++}else{if(parseInt(F)-1>0&&H[parseInt(F)-1][parseInt(E)+1]==undefined){this.x--}else{G.fillStyle="#fff";G.fillRect(F,E,this.size,this.size);H[parseInt(F)][parseInt(E)]=1;this.reset()}}}}}}if(this.x>(s)-k||this.x<k){this.reset()}};this.reset=function(){this.y=0;this.x=b(k,s-k);this.stepSize=b(1,10)/100;this.size=b((f.minSize*100),(f.maxSize*100))/100;this.speed=b(f.minSpeed,f.maxSpeed)}}var t=[],c=0,u=0,q=a(d).height(),s=a(d).width(),k=0,x=0;if(f.collection!==false){var g=document.createElement("canvas");if(!!(g.getContext&&g.getContext("2d"))){var v=[],r=a(f.collection),y=f.collectionHeight;for(var u=0;u<r.length;u++){var m=r[u].getBoundingClientRect(),e=document.createElement("canvas"),n=[];if(m.top-y>0){document.body.appendChild(e);e.style.position="absolute";e.height=y;e.width=m.width;e.style.left=m.left+"px";e.style.top=m.top-y+"px";for(var p=0;p<m.width;p++){n[p]=[]}v.push({element:e,x:m.left,y:m.top-y,width:m.width,height:y,colData:n})}}}else{f.collection=false}}if(a(d).get(0).tagName===a(document).get(0).tagName){k=25}a(window).bind("resize",function(){q=a(d).height();s=a(d).width()});for(u=0;u<f.flakeCount;u+=1){c=t.length;t.push(new h(b(k,s-k),b(0,q),b((f.minSize*100),(f.maxSize*100))/100,b(f.minSpeed,f.maxSpeed),c))}if(f.round){a(".snowfall-flakes").css({"-moz-border-radius":f.maxSize,"-webkit-border-radius":f.maxSize,"border-radius":f.maxSize})}if(f.shadow){a(".snowfall-flakes").css({"-moz-box-shadow":"1px 1px 1px #555","-webkit-box-shadow":"1px 1px 1px #555","box-shadow":"1px 1px 1px #555"})}var l=false;if(f.deviceorientation){a(window).bind("deviceorientation",function(w){l=w.originalEvent.gamma*0.1})}function j(){for(u=0;u<t.length;u+=1){t[u].update()}x=setTimeout(function(){j()},30)}j();this.clear=function(){a(d).children(".snowfall-flakes").remove();t=[];clearTimeout(x)}};a.fn.snowfall=function(b){if(typeof(b)=="object"||b==undefined){return this.each(function(c){(new a.snowfall(this,b))})}else{if(typeof(b)=="string"){return this.each(function(c){var d=a(this).data("snowfall");if(d){d.clear()}})}}}})(jQuery);